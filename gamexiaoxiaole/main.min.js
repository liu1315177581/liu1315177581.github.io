var __reflect=this&&this.__reflect||function(e,a,t){e.__class__=a,t?t.push(a):t=[a],e.__types__=e.__types__?t.concat(e.__types__):t},__extends=this&&this.__extends||function(e,a){function t(){this.constructor=e}for(var n in a)a.hasOwnProperty(n)&&(e[n]=a[n]);e.prototype=null===a?Object.create(a):(t.prototype=a.prototype,new t)},BaseElement=function(){function e(){this.type=""}return e}();__reflect(BaseElement.prototype,"BaseElement");var PropViewManage=function(){function e(e){this._currentID=-1,this._layer=e,this.init()}return e.prototype.init=function(){this._props=new Array,this.testdata()},e.prototype.testdata=function(){for(var e=0;5>e;e++){var a=new PropView(e);a.x=15+(5+a.width)*e,a.y=GameData.stageH-a.height-10,this._layer.addChild(a),this._props.push(a),a.num=Math.floor(5*Math.random())+10,a.id=e,a.addEventListener(egret.TouchEvent.TOUCH_TAP,this.click,this)}},e.prototype.click=function(a){-1!=this._currentID?(this._props[this._currentID].setFocus(!1),this._currentID==a.currentTarget.id?(this._currentID=-1,e.propType=-1):(this._currentID=a.currentTarget.id,this._props[this._currentID].setFocus(!0),e.propType=this._props[this._currentID].proptype)):(this._currentID=a.currentTarget.id,this._props[this._currentID].setFocus(!0),e.propType=this._props[this._currentID].proptype)},e.prototype.useProp=function(){console.log("当前焦点ID",this._currentID),this._props[this._currentID].num--,this._props[this._currentID].setFocus(!1),this._currentID=-1,e.propType=-1},e}();PropViewManage.propType=-1,__reflect(PropViewManage.prototype,"PropViewManage");var LevelRequireElement=function(e){function a(){var a=null!==e&&e.apply(this,arguments)||this;return a.num=0,a}return __extends(a,e),a}(BaseElement);__reflect(LevelRequireElement.prototype,"LevelRequireElement");var ElementTypeParse=function(){function e(){}return e.creatElementTypeData=function(e){GameData.elementTypes=e},e}();__reflect(ElementTypeParse.prototype,"ElementTypeParse");var GameBackGround=function(e){function a(){return e.call(this)||this}return __extends(a,e),a.prototype.changeBackground=function(){this.cacheAsBitmap=!1,this.removeChildren(),this.createBackGroundImage(),this.createMapBg(),this.createLevelReqBg(),this.createStepBg(),this.cacheAsBitmap=!0},a.prototype.createBackGroundImage=function(){this.bgImage||(this.bgImage=new egret.Bitmap),this.bgImage.texture=RES.getRes(GameData.levelBackgroundImageName),this.bgImage.width=GameData.stageW,this.bgImage.height-GameData.stageH,this.addChild(this.bgImage);var e=new egret.Bitmap;e.texture=RES.getRes("propbg_png"),e.width=GameData.stageW,e.height=GameData.stageW/5+20,e.y=GameData.stageH-e.height,this.addChild(e)},a.prototype.createMapBg=function(){this.girdBg||(this.girdBg=new Array);for(var e,a=(GameData.stageW-40)/GameData.MaxColumn,t=GameData.stageH-(GameData.stageW-30)/6-60-a*GameData.MaxColumn,n=0;n<GameData.MaxRow;n++)for(var i=0;i<GameData.MaxColumn;i++)-1!=GameData.mapData[n][i]&&(this.girdBg.length<=n*GameData.MaxRow+i?(e=new egret.Bitmap,this.girdBg.push(e)):e=this.girdBg[n*GameData.MaxRow+i],e.width=a,e.height=a,e.x=20+a*i,e.y=t+a*n,n%2==0&&i%2==0||n%2==1&&i%2==1?e.texture=RES.getRes("elementbg1_png"):e.texture=RES.getRes("elementbg2_png"),this.addChild(e))},a.prototype.createLevelReqBg=function(){var e=(GameData.stageW-40)/GameData.MaxColumn,a=new egret.Bitmap;a.texture=RES.getRes("levelreqbg_png"),a.width=GameData.levelReq.getLevelReqNum()*(10+e)+20,a.height=e+60,a.x=20,a.y=50,this.addChild(a);var t=new egret.Bitmap;t.texture=RES.getRes("levelreqtitle_png"),t.x=a.x+(a.width-t.width)/2,t.y=a.y-18,this.addChild(t)},a.prototype.createStepBg=function(){var e=new egret.Bitmap;e.texture=RES.getRes("levelregbg_png"),e.width=100,e.height=100,e.x=GameData.stageW-110,e.y=50,this.addChild(e);var a=new egret.Bitmap;a.texture=RES.getRes("sursteptitle_png"),a.x=e.x+(e.width-a.width)/2,a.y=e.y+10,this.addChild(a)},a}(egret.Sprite);__reflect(GameBackGround.prototype,"GameBackGround");var GameData=function(){function e(){}return e.initData=function(){e.mapData=new Array;for(var a=0;a<e.MaxRow;a++){var t=new Array;e.mapData.push(t);for(var n=0;n<e.MaxColumn;n++)e.mapData[a].push(-2)}e.levelReq=new LevelRequire,e.elements=new Array,e.unusedElements=new Array;for(var i,o=e.MaxRow*e.MaxColumn,a=0;o>a;a++)i=new GameElement,i.id=a,e.elements.push(i),e.unusedElements.push(a);e.stageW=egret.MainContext.instance.stage.stageWidth,e.stageH=egret.MainContext.instance.stage.stageHeight},e}();GameData.unmapnum=0,GameData.stepNum=0,GameData.levelStepNum=0,GameData.levelBackgroundImageName="",GameData.MaxRow=8,GameData.MaxColumn=8,GameData.currentElementNum=0,GameData.stageW=0,GameData.stageH=0,__reflect(GameData.prototype,"GameData");var LevelGameDataParse=function(){function e(){}return e.parseLevelGameData=function(a){GameData.stepNum=a.step,GameData.levelStepNum=a.step,GameData.elementTypes=a.element,GameData.levelBackgroundImageName=a.levelbgimg,e.parseLevelReq(a.levelreq)},e.parseLevelReq=function(e){GameData.levelReq.openChange();for(var a=e.length,t=0;a>t;t++)GameData.levelReq.addElements(e[t].type,e[t].num)},e}();__reflect(LevelGameDataParse.prototype,"LevelGameDataParse");var LevelRequire=function(){function e(){this.reqElements=new Array}return e.prototype.getLevelReqNum=function(){return this.reqElements.length},e.prototype.addElements=function(e,a){var t=new LevelRequireElement;t.num=a,t.type=e,this.reqElements.push(t)},e.prototype.openChange=function(){this.reqElements=[]},e.prototype.changeReqNum=function(e,a){for(var t=this.getLevelReqNum(),n=0;t>n;n++)if(this.reqElements[n].type==e)return this.reqElements[n].num-=a,void console.log("最新数量",this.reqElements[n].num)},e.prototype.isClear=function(){for(var e=this.getLevelReqNum(),a=0;e>a;a++)if(this.reqElements[a].num>0)return!1;return!0},e}();__reflect(LevelRequire.prototype,"LevelRequire");var LinkLogic=function(){function e(){}return e.isHaveLine=function(){this.lines=new Array;for(var a="",t=0,n=0;n<GameData.MaxRow;n++){for(var i=0;i<GameData.MaxColumn;i++)if(-1!=GameData.mapData[n][i])if(a!=GameData.elements[GameData.mapData[n][i]].type){if(t>=3){for(var o=new Array,s=0;t>s;s++)o.push(GameData.mapData[n][i-s-1]),console.log("横压入数组",n,i-s-1,GameData.mapData[n][i-s-1]);this.lines.push(o)}a=GameData.elements[GameData.mapData[n][i]].type,t=1}else t++;else{if(t>=3){for(var o=new Array,s=0;t>s;s++)o.push(GameData.mapData[n][i-s-1]),console.log("横压入数组",n,i-s-1,GameData.mapData[n][i-s-1]);this.lines.push(o)}a="",t=0}if(t>=3){for(var i=GameData.MaxColumn,o=new Array,s=0;t>s;s++)console.log("横压入数组2",n,i-s-1,GameData.mapData[n][i-s-1]),o.push(GameData.mapData[n][i-s-1]);this.lines.push(o)}a="",t=0}for(var i=0;i<GameData.MaxColumn;i++){for(var n=0;n<GameData.MaxRow;n++)if(-1!=GameData.mapData[n][i])if(a!=GameData.elements[GameData.mapData[n][i]].type){if(t>=3){for(var o=new Array,s=0;t>s;s++)o.push(GameData.mapData[n-s-1][i]),console.log("纵压入数组",n-s-1,i,GameData.mapData[n-s-1][i]);this.lines.push(o)}a=GameData.elements[GameData.mapData[n][i]].type,t=1}else t++;else{if(t>=3){for(var o=new Array,s=0;t>s;s++)o.push(GameData.mapData[n-s-1][i]),console.log("纵压入数组",n-s-1,i,GameData.mapData[n-s-1][i]);this.lines.push(o)}a="",t=0}if(t>=3){for(var n=GameData.MaxRow,o=new Array,s=0;t>s;s++)o.push(GameData.mapData[n-s-1][i]),console.log("纵压入数组",n-s-1,i,GameData.mapData[n-s-1][i]);this.lines.push(o)}a="",t=0}return 0!=e.lines.length?(console.log("未过滤数组",e.lines),!0):!1},e.isHaveLineByIndex=function(e,a){var t=GameData.mapData[Math.floor(e/GameData.MaxColumn)][e%GameData.MaxRow],n=GameData.mapData[Math.floor(a/GameData.MaxColumn)][a%GameData.MaxRow];GameData.mapData[Math.floor(e/GameData.MaxColumn)][e%GameData.MaxRow]=n,GameData.mapData[Math.floor(a/GameData.MaxColumn)][a%GameData.MaxRow]=t;var i=this.isHaveLine();return i?(GameData.elements[t].location=a,GameData.elements[n].location=e,!0):(GameData.mapData[Math.floor(e/GameData.MaxColumn)][e%GameData.MaxRow]=t,GameData.mapData[Math.floor(a/GameData.MaxColumn)][a%GameData.MaxRow]=n,!1)},e.canMove=function(e,a){var t=Math.floor(GameData.elements[e].location/GameData.MaxRow),n=GameData.elements[e].location%GameData.MaxColumn,i=Math.floor(GameData.elements[a].location/GameData.MaxRow),o=GameData.elements[a].location%GameData.MaxColumn;if(console.log("判断两点互换位置",e,GameData.elements[e].location,t,n,"第二个",a,GameData.elements[a].location,i,o),t==i){if(n-o==1||n-o==-1)return!0}else if(n==o&&(t-i==1||t-i==-1))return!0;return!1},e.isNextHaveLine=function(){for(var e=0;e<GameData.MaxRow;e++)for(var a=0;a<GameData.MaxColumn;a++)if(-1!=GameData.mapData[e][a]){if(a<GameData.MaxColumn-1&&-1!=GameData.mapData[e][a+1]&&GameData.elements[GameData.mapData[e][a]].type==GameData.elements[GameData.mapData[e][a+1]].type){if(a>0&&-1!=GameData.mapData[e][a-1]){if(e>0&&a>0&&GameData.mapData[e-1][a-1]&&-1!=GameData.mapData[e-1][a-1]&&GameData.elements[GameData.mapData[e-1][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("-1能消除项目1！！！",e,a),!0;if(e<GameData.MaxRow-1&&a>0&&GameData.mapData[e+1][a-1]&&-1!=GameData.mapData[e+1][a-1]&&GameData.elements[GameData.mapData[e+1][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("-1能消除项目2！！！",e,a),!0;if(a>1&&GameData.mapData[e][a-2]&&-1!=GameData.mapData[e][a-2]&&GameData.elements[GameData.mapData[e][a-2]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("-1能消除项目3！！！",e,a),!0}if(a<GameData.MaxColumn-1&&-1!=GameData.mapData[e][a+2]){if(a<GameData.MaxColumn-2&&e>0&&GameData.mapData[e-1][a+2]&&-1!=GameData.mapData[e-1][a+2]&&GameData.elements[GameData.mapData[e-1][a+2]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("-1能消除项目4！！！",e,a),!0;if(a<GameData.MaxColumn-2&&e<GameData.MaxRow-1&&GameData.mapData[e+1][a+2]&&-1!=GameData.mapData[e+1][a+2]&&GameData.elements[GameData.mapData[e+1][a+2]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("-1能消除项目5！！！",e,a),!0;if(a<GameData.MaxColumn-3&&GameData.mapData[e][a+3]&&-1!=GameData.mapData[e][a+3]&&GameData.elements[GameData.mapData[e][a+3]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("-1能消除项目6！！！",e,a),!0}}if(e<GameData.MaxRow-1&&-1!=GameData.mapData[e+1][a]&&GameData.elements[GameData.mapData[e][a]].type==GameData.elements[GameData.mapData[e+1][a]].type){if(e>0&&-1!=GameData.mapData[e-1][a]){if(e>1&&GameData.mapData[e-2][a]&&-1!=GameData.mapData[e-2][a]&&GameData.elements[GameData.mapData[e-2][a]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("|1能消除项目1！！！",e,a),!0;if(e>0&&a>0&&GameData.mapData[e-1][a-1]&&-1!=GameData.mapData[e-1][a-1]&&GameData.elements[GameData.mapData[e-1][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("|1能消除项目2！！！",e,a),!0;if(e>0&&a<GameData.MaxColumn-1&&GameData.mapData[e-1][a+1]&&-1!=GameData.mapData[e-1][a+1]&&GameData.elements[GameData.mapData[e-1][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("|1能消除项目3！！！",e,a),!0}if(e<GameData.MaxRow-2&&-1!=GameData.mapData[e+2][a]){if(e<GameData.MaxRow-3&&GameData.mapData[e+3][a]&&-1!=GameData.mapData[e+3][a]&&GameData.elements[GameData.mapData[e+3][a]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("|1能消除项目4！！！",e,a),!0;if(a<GameData.MaxColumn-2&&GameData.mapData[e+2][a+1]&&-1!=GameData.mapData[e+2][a+1]&&GameData.elements[GameData.mapData[e+2][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("|1能消除项目5！！！",e,a),!0;if(a>0&&GameData.mapData[e+2][a-1]&&-1!=GameData.mapData[e+2][a-1]&&GameData.elements[GameData.mapData[e+2][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("|1能消除项目6！！！",e,a),!0}}if(a<GameData.MaxColumn-2&&-1!=GameData.mapData[e][a+2]&&GameData.elements[GameData.mapData[e][a]].type==GameData.elements[GameData.mapData[e][a+2]].type&&-1!=GameData.mapData[e][a+1]){if(e>0&&GameData.mapData[e-1][a+1]&&-1!=GameData.mapData[e-1][a+1]&&GameData.elements[GameData.mapData[e-1][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("-2能消除项目1！！！",e,a),!0;if(e<GameData.MaxRow-1&&GameData.mapData[e+1][a+1]&&-1!=GameData.mapData[e+1][a+1]&&GameData.elements[GameData.mapData[e+1][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("-2能消除项目2！！！",e,a),!0}if(e<GameData.MaxRow-2&&-1!=GameData.mapData[e+2][a]&&GameData.elements[GameData.mapData[e][a]].type==GameData.elements[GameData.mapData[e+2][a]].type&&-1!=GameData.mapData[e+1][a]){if(a<GameData.MaxColumn-1&&GameData.mapData[e+1][a+1]&&-1!=GameData.mapData[e+1][a+1]&&GameData.elements[GameData.mapData[e+1][a+1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("|2能消除项目1！！！",e,a),!0;if(e<GameData.MaxRow-1&&a>0&&GameData.mapData[e+1][a-1]&&-1!=GameData.mapData[e+1][a-1]&&GameData.elements[GameData.mapData[e+1][a-1]].type==GameData.elements[GameData.mapData[e][a]].type)return console.log("|2能消除项目2！！！",e,a),!0}}return!1},e.changeOrder=function(){for(var e=new Array,a=0;a<GameData.MaxRow;a++)for(var t=0;t<GameData.MaxColumn;t++)-1!=GameData.mapData[a][t]&&e.push(GameData.mapData[a][t]);for(var n=0,a=0;a<GameData.MaxRow;a++)for(var t=0;t<GameData.MaxColumn;t++)-1!=GameData.mapData[a][t]&&(n=Math.floor(Math.random()*e.length),GameData.mapData[a][t]=e[n],GameData.elements[e[n]].location=a*GameData.MaxColumn+t,e.splice(n,1))},e}();__reflect(LinkLogic.prototype,"LinkLogic");var MapControl=function(){function e(){}return e.prototype.createElementAllMap=function(){this.createAllMap()},e.prototype.createAllMap=function(){for(var e=(GameData.MaxColumn*GameData.MaxRow,""),a=!0,t=0,n="",i="",o=0;o<GameData.MaxRow;o++)for(var s=0;s<GameData.MaxColumn;s++)if(-1!=GameData.mapData[o][s]){for(;a;)e=this.createType(),o>1&&-1!=GameData.mapData[o-1][s]&&-1!=GameData.mapData[o-2][s]&&GameData.elements[GameData.mapData[o-1][s]].type==GameData.elements[GameData.mapData[o-2][s]].type&&(n=GameData.elements[GameData.mapData[o-1][s]].type),s>1&&-1!=GameData.mapData[o][s-1]&&-1!=GameData.mapData[o][s-2]&&GameData.elements[GameData.mapData[o][s-1]].type==GameData.elements[GameData.mapData[o][s-2]].type&&(i=GameData.elements[GameData.mapData[o][s-1]].type),e!=n&&e!=i&&(a=!1);t=GameData.unusedElements[0],GameData.elements[t].type=e,GameData.elements[t].location=o*GameData.MaxRow+s,GameData.mapData[o][s]=t,GameData.unusedElements.shift(),a=!0,n="",i=""}},e.prototype.createType=function(){return GameData.elementTypes[Math.floor(Math.random()*GameData.elementTypes.length)].toString()},e.prototype.changeTypeByID=function(e){GameData.elements[e].type=this.createType(),console.log(e,GameData.elements[e].type)},e.prototype.updateMapLocation=function(){for(var e=new Array,a=LinkLogic.lines.length,t=0;a>t;t++)for(var n=LinkLogic.lines[t].length,i=0;n>i;i++)-1==e.indexOf(LinkLogic.lines[t][i])&&(this.changeTypeByID(LinkLogic.lines[t][i]),e.push(LinkLogic.lines[t][i]));a=e.length;for(var o=new Array,t=0;a>t;t++){var s=GameData.elements[e[t]].location%GameData.MaxColumn;-1==o.indexOf(s)&&o.push(s)}a=o.length;for(var t=0;a>t;t++){for(var m=new Array,r=new Array,i=GameData.MaxRow-1;i>=0;i--)-1==e.indexOf(GameData.mapData[i][o[t]])?-1!=GameData.mapData[i][o[t]]&&r.push(GameData.mapData[i][o[t]]):m.push(GameData.mapData[i][o[t]]);r=r.concat(m);for(var i=GameData.MaxRow-1;i>=0;i--)-1!=GameData.mapData[i][o[t]]&&(GameData.mapData[i][o[t]]=r[0],GameData.elements[r[0]].location=i*GameData.MaxRow+o[t],r.shift())}},e}();__reflect(MapControl.prototype,"MapControl");var MapDataParse=function(){function e(){}return e.createMapData=function(e){var a=e.length;GameData.unmapnum=a;for(var t=0,n=0;a>n;n++)t=e[n],GameData.mapData[Math.floor(t/GameData.MaxColumn)][t%GameData.MaxRow]=-1;GameData.currentElementNum=GameData.MaxColumn*GameData.MaxRow-a},e}();__reflect(MapDataParse.prototype,"MapDataParse");var GameElement=function(e){function a(){var a=null!==e&&e.apply(this,arguments)||this;return a.id=0,a.location=0,a}return __extends(a,e),a}(BaseElement);__reflect(GameElement.prototype,"GameElement");var ElementViewManageEvent=function(e){function a(a,t,n){void 0===t&&(t=!1),void 0===n&&(n=!1);var i=e.call(this,a,t,n)||this;return i.propToElementLocation=0,i.ele1=0,i.ele2=0,i}return __extends(a,e),a}(egret.Event);ElementViewManageEvent.TAP_TWO_ELEMENT="tap_two_element",ElementViewManageEvent.REMOVE_ANIMATION_OVER="remove_animation_over",ElementViewManageEvent.UPDATE_MAP="update_map",ElementViewManageEvent.UPDATE_VIEW_OVER="update_view_over",ElementViewManageEvent.USE_PROP_CLICK="use_prop_click",__reflect(ElementViewManageEvent.prototype,"ElementViewManageEvent");var GameLogic=function(){function e(e){this._gameStage=e,this.init()}return e.prototype.init=function(){GameData.initData();var e=RES.getRes("l1_json");MapDataParse.createMapData(e.map),LevelGameDataParse.parseLevelGameData(e),ElementTypeParse.creatElementTypeData(e.element),this.mapc=new MapControl,this.mapc.createElementAllMap();var a=new GameBackGround;this._gameStage.addChild(a),a.changeBackground();var t=new egret.Sprite;this._gameStage.addChild(t),this.levm=new LevelReqViewManage(t),this.levm.createCurrentLevelReq();var n=new egret.Sprite;this._gameStage.addChild(n),this.pvm=new PropViewManage(n);var i=new egret.Sprite;this._gameStage.addChild(i),this.evm=new ElementViewManage(i),this.evm.showAllElements(),this.evm.addEventListener(ElementViewManageEvent.REMOVE_ANIMATION_OVER,this.removeAndOver,this),this.evm.addEventListener(ElementViewManageEvent.TAP_TWO_ELEMENT,this.viewTouchTap,this),this.evm.addEventListener(ElementViewManageEvent.UPDATE_MAP,this.createNewElement,this),this.evm.addEventListener(ElementViewManageEvent.UPDATE_VIEW_OVER,this.checkOtherElementLink,this),this.evm.addEventListener(ElementViewManageEvent.USE_PROP_CLICK,this.usePropClick,this)},e.prototype.usePropClick=function(e){PropLogic.useProp(PropViewManage.propType,e.propToElementLocation),this.pvm.useProp(),this.removeAndOver(null)},e.prototype.viewTouchTap=function(e){var a=LinkLogic.canMove(e.ele1,e.ele2);if(a){var t=LinkLogic.isHaveLineByIndex(GameData.elements[e.ele1].location,GameData.elements[e.ele2].location);console.log("移动后是否能消除",t),t?(console.log("消除动画"),this.evm.changeLocationWithScaleOrBack(e.ele1,e.ele2),GameData.stepNum>=1&&(GameData.stepNum--,this.levm.updateStep())):this.evm.changeLocationWithScaleOrBack(e.ele1,e.ele2,!0)}else this.evm.setNewElementFocus(e.ele2)},e.prototype.removeAndOver=function(e){console.log("需要消除"+LinkLogic.lines);for(var a,t=LinkLogic.lines.length,n=0;t>n;n++)for(var i=LinkLogic.lines[n].length,o="",s=0;i>s;s++)if(o=GameData.elements[LinkLogic.lines[n][s]].type,a=this.levm.haveReqType(o)){var m=this.levm.getPointByType(o);GameData.levelReq.changeReqNum(o,1),this.levm.update(),this.evm.playReqRemoveAn(LinkLogic.lines[n][s],m.x,m.y)}else this.evm.playRemoveAni(LinkLogic.lines[n][s])},e.prototype.createNewElement=function(e){console.log("刷新地图数据！！！！！！！！"),this.mapc.updateMapLocation(),this.evm.updateMapData()},e.prototype.checkOtherElementLink=function(e){if(LinkLogic.isHaveLine())this.removeAndOver(null);else if(console.log("检查是否有可消除元素!"),!LinkLogic.isNextHaveLine())for(;;)if(console.log("执行乱序"),LinkLogic.changeOrder(),!LinkLogic.isHaveLine()&&LinkLogic.isNextHaveLine()){this.evm.updateOrder();break}console.log("所有动画逻辑结束"),this.isGameOver()},e.prototype.isGameOver=function(){console.log("过关元素是否清空",GameData.levelReq.isClear()),this.gameoverpanel||(0==GameData.stepNum?(this.gameoverpanel=new GameOverPanel,this._gameStage.addChild(this.gameoverpanel),GameData.levelReq.isClear()?this.gameoverpanel.show(!0):this.gameoverpanel.show(!1)):GameData.levelReq.isClear()&&(this.gameoverpanel=new GameOverPanel,this._gameStage.addChild(this.gameoverpanel),this.gameoverpanel.show(!0)))},e}();__reflect(GameLogic.prototype,"GameLogic");var LoadingUI=function(e){function a(){var a=e.call(this)||this;return a.createView(),a}return __extends(a,e),a.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},a.prototype.setProgress=function(e,a){this.textField.text="Loading..."+e+"/"+a},a}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(e){function a(){var a=e.call(this)||this;return a.addEventListener(egret.Event.ADDED_TO_STAGE,a.onAddToStage,a),a}return __extends(a,e),a.prototype.onAddToStage=function(e){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},a.prototype.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("game")},a.prototype.onResourceLoadComplete=function(e){"game"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},a.prototype.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},a.prototype.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},a.prototype.onResourceProgress=function(e){"game"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},a.prototype.createGameScene=function(){var e=new egret.Sprite;this.addChild(e),this._gl=new GameLogic(e)},a}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var ElementView=function(e){function a(a){var t=e.call(this)||this;return t.location=0,t._id=-1,t._focus=!1,t.speed=700,t.thisParent=a,t.init(),t}return __extends(a,e),Object.defineProperty(a.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e},enumerable:!0,configurable:!0}),a.prototype.init=function(){this.touchEnabled=!0,this.touchChildren=!1,this.bitmap=new egret.Bitmap;var e=(GameData.stageW-40)/GameData.MaxColumn;this.bitmap.width=e-10,this.bitmap.height=e-10,this.bitmap.x=-1*e/2,this.bitmap.y=-1*e/2,this.addChild(this.bitmap)},a.prototype.setTexture=function(e){this.bitmap.texture=RES.getRes(e)},Object.defineProperty(a.prototype,"focus",{get:function(){return this._focus},enumerable:!0,configurable:!0}),a.prototype.setFocus=function(e){e!=this.focus&&(this._focus=e,e?this.setTexture("e"+GameData.elements[this.id].type+"foucs_png"):this.setTexture("e"+GameData.elements[this.id].type+"_png"))},a.prototype.move=function(){var e=egret.Tween.get(this);e.to({x:this.targetX(),y:this.targetY()},this.speed,egret.Ease.cubicInOut)},a.prototype.show=function(e){var a=egret.Tween.get(this);a.wait(e,!1),a.call(this.addThisToParent,this),a.to({x:this.targetX(),y:this.targetY()},this.speed,egret.Ease.bounceOut)},a.prototype.addThisToParent=function(){this.parent||this.thisParent.addChild(this)},a.prototype.targetX=function(){var e=(GameData.stageW-40)/GameData.MaxColumn,a=20+e*(this.location%GameData.MaxColumn)+e/2+5;return a},a.prototype.targetY=function(){var e=(GameData.stageW-40)/GameData.MaxColumn,a=GameData.stageH-(GameData.stageW-30)/6-60-e*GameData.MaxColumn,t=a+e*Math.floor(this.location/8)+e/2+5;return t},a.prototype.moveAndBack=function(e,a){void 0===a&&(a=!1);var t=(GameData.stageW-40)/GameData.MaxColumn,n=20+t*(e%GameData.MaxColumn)+t/2+5,i=GameData.stageH-(GameData.stageW-30)/6-60-t*GameData.MaxColumn,o=i+t*Math.floor(e/GameData.MaxColumn)+t/2+5,s=egret.Tween.get(this);a?s.to({x:n,y:o,scaleX:1.2,scaleY:1.2},300,egret.Ease.cubicOut).call(this.back,this):s.to({x:n,y:o,scaleX:.8,scaleY:.8},300,egret.Ease.cubicOut).call(this.back,this)},a.prototype.back=function(){var e=egret.Tween.get(this);e.to({x:this.targetX(),y:this.targetY(),scaleX:1,scaleY:1},300,egret.Ease.cubicOut)},a.prototype.moveAndScale=function(e,a){void 0===a&&(a=!1);var t=(GameData.stageW-40)/GameData.MaxColumn,n=20+t*(e%GameData.MaxColumn)+t/2+5,i=GameData.stageH-(GameData.stageW-30)/6-60-t*GameData.MaxColumn,o=i+t*Math.floor(e/GameData.MaxRow)+t/2+5,s=egret.Tween.get(this);a?s.to({x:n,y:o,scaleX:1.4,scaleY:1.4},300,egret.Ease.cubicInOut).call(this.backScaleNoCall,this):s.to({x:n,y:o,scaleX:.6,scaleY:.6},300,egret.Ease.cubicInOut).call(this.backScale,this)},a.prototype.backScale=function(){var e=egret.Tween.get(this);e.to({scaleX:1,scaleY:1},300,egret.Ease.backOut).call(this.canRemove,this)},a.prototype.backScaleNoCall=function(){var e=egret.Tween.get(this);e.to({scaleX:1,scaleY:1},300,egret.Ease.backOut)},a.prototype.canRemove=function(){var e=new ElementViewManageEvent(ElementViewManageEvent.REMOVE_ANIMATION_OVER);this.evm.dispatchEvent(e)},a.prototype.playRemoveAni=function(){var e=egret.Tween.get(this);e.to({scaleX:1.4,scaleY:1.4},300,egret.Ease.cubicInOut).to({scaleX:.1,scaleY:.1},300,egret.Ease.cubicInOut).call(this.removeAniCall,this)},a.prototype.removeAniCall=function(){this.parent&&this.parent.removeChild(this);var e=new ElementViewManageEvent(ElementViewManageEvent.UPDATE_MAP);this.evm.updateMap(e)},a.prototype.playCurveMove=function(e,a){var t=egret.Tween.get(this);t.to({x:e,y:a},700,egret.Ease.quadOut).call(this.overCurveMove,this)},a.prototype.overCurveMove=function(){this.parent&&this.parent.removeChild(this);var e=new ElementViewManageEvent(ElementViewManageEvent.UPDATE_MAP);this.evm.updateMap(e)},a.prototype.moveNewLocation=function(){if(!this.parent){var e=(GameData.stageW-40)/GameData.MaxColumn,a=GameData.stageH-(GameData.stageW-30)/6-60-e*GameData.MaxColumn;this.y=a-this.width,this.scaleX=1,this.scaleY=1,this.x=this.targetX(),this.thisParent.addChild(this)}egret.Tween.get(this).to({x:this.targetX(),y:this.targetY()},this.speed,egret.Ease.bounceOut).call(this.moveNewLocationOver,this)},a.prototype.moveNewLocationOver=function(){var e=new ElementViewManageEvent(ElementViewManageEvent.UPDATE_VIEW_OVER);this.evm.moveNewLocationOver(e)},a}(egret.Sprite);__reflect(ElementView.prototype,"ElementView");var ElementViewManage=function(e){function a(a){var t=e.call(this)||this;return t._currentTapID=-1,t.moveEleNum=0,t.moveLocElementNum=0,t._layer=a,t.init(),t}return __extends(a,e),a.prototype.init=function(){this.elementViews=new Array;for(var e,a=GameData.MaxColumn*GameData.MaxRow,t=0;a>t;t++)e=new ElementView(this._layer),e.id=t,e.location=GameData.elements[t].location,this.elementViews.push(e),e.evm=this,e.addEventListener(egret.TouchEvent.TOUCH_TAP,this.elTap,this)},a.prototype.elTap=function(e){var a=e.currentTarget;if(-1==PropViewManage.propType)if(-1!=this._currentTapID)if(a.id==this._currentTapID)a.setFocus(!1),this._currentTapID=-1;else{var t=new ElementViewManageEvent(ElementViewManageEvent.TAP_TWO_ELEMENT);t.ele1=this._currentTapID,t.ele2=a.id,this.dispatchEvent(t)}else a.setFocus(!0),this._currentTapID=a.id;else{-1!=this._currentTapID&&(this._currentTapID=-1);var n=new ElementViewManageEvent(ElementViewManageEvent.USE_PROP_CLICK);n.propToElementLocation=a.location,this.dispatchEvent(n)}},a.prototype.setNewElementFocus=function(e){this.elementViews[this._currentTapID].setFocus(!1),this.elementViews[e].setFocus(!0),this._currentTapID=e},a.prototype.showAllElements=function(){this._layer.removeChildren();for(var e,a=(GameData.stageW-40)/GameData.MaxColumn,t=GameData.stageH-(GameData.stageW-30)/6-60-a*GameData.MaxColumn,n=0;n<GameData.MaxRow;n++)for(var i=0;i<GameData.MaxColumn;i++)-1!=GameData.mapData[n][i]&&(e=this.elementViews[GameData.mapData[n][i]],e.setTexture("e"+GameData.elements[GameData.mapData[n][i]].type+"_png"),e.x=e.targetX(),e.y=t-e.width,e.show(50*GameData.MaxColumn*GameData.MaxRow-50*GameData.unmapnum-50*(n*GameData.MaxRow+i)))},a.prototype.changeLocationWithScaleOrBack=function(e,a,t){void 0===t&&(t=!1);var n=e,i=a;this.elementViews[a].focus&&(n=a,i=e),this.elementViews[n].setFocus(!1),this._layer.getChildIndex(this.elementViews[n])<this._layer.getChildIndex(this.elementViews[i])&&this._layer.swapChildren(this.elementViews[n],this.elementViews[i]),t?(this.elementViews[n].moveAndBack(this.elementViews[i].location,!0),this.elementViews[i].moveAndBack(this.elementViews[n].location)):(this.elementViews[n].moveAndScale(this.elementViews[i].location,!0),this.elementViews[i].moveAndScale(this.elementViews[n].location)),this._currentTapID=-1},a.prototype.playReqRemoveAn=function(e,a,t){this.moveEleNum++;var n=this.elementViews[e];n.parent&&this._layer.setChildIndex(n,this._layer.numChildren),n.playCurveMove(a,t)},a.prototype.playRemoveAni=function(e){this.moveEleNum++;var a=this.elementViews[e];a.parent&&this._layer.setChildIndex(a,this._layer.numChildren),a.playRemoveAni()},a.prototype.updateMap=function(e){this.moveEleNum--,0==this.moveEleNum&&this.dispatchEvent(e)},a.prototype.updateMapData=function(){console.log("重新布局");for(var e=this.elementViews.length,a=0;e>a;a++)this.elementViews[a].location=GameData.elements[a].location,this.elementViews[a].setTexture("e"+GameData.elements[a].type+"_png"),this.elementViews[a].moveNewLocation()},a.prototype.moveNewLocationOver=function(e){if(this.moveLocElementNum++,this.moveLocElementNum==GameData.MaxColumn*GameData.MaxRow){var a=new ElementViewManageEvent(ElementViewManageEvent.UPDATE_VIEW_OVER);this.dispatchEvent(a),this.moveLocElementNum=0}},a.prototype.updateOrder=function(){var e=this.elementViews.length;egret.Tween.removeAllTweens();for(var a=0;e>a;a++)this.elementViews[a].location=GameData.elements[a].location,this.elementViews[a].move()},a}(egret.EventDispatcher);__reflect(ElementViewManage.prototype,"ElementViewManage");var GameOverPanel=function(e){function a(){var a=e.call(this)||this;return a._isSuccess=!1,a}return __extends(a,e),a.prototype.show=function(e){this._isSuccess=e,this._view=new egret.Bitmap,this._view.texture=RES.getRes("level_0002_background_png"),this._view.width=GameData.stageW,this._view.height=GameData.stageH,this.addChild(this._view),this.scaleX=.1,this.scaleY=.1,egret.Tween.get(this).to({scaleX:1,scaleY:1},700,egret.Ease.bounceOut).call(this.playStarAni,this),this.playStarAni()},a.prototype.playStarAni=function(){if(console.log("播放失败动画"),this._isSuccess){var e=new egret.Bitmap;e.texture=RES.getRes("success_png"),e.width=(this._view.width-50)/3,e.height=e.width,e.x=(GameData.stageW-2*e.width)/3+this._view.x,e.y=150+this._view.y,e.scaleX=1.5,e.scaleY=1.5,e.alpha=0,this.addChild(e),egret.Tween.get(e).to({scaleX:1,scaleY:1,alpha:1},700,egret.Ease.circIn)}else{var a=new egret.Bitmap;a.texture=RES.getRes("fail_png"),a.width=(this._view.width-50)/3,a.height=a.width,a.x=(GameData.stageW-2*a.width)/3+this._view.x,a.y=150+this._view.y,a.scaleX=1.5,a.scaleY=1.5,a.alpha=0,this.addChild(a),egret.Tween.get(a).to({scaleX:1,scaleY:1,alpha:1},700,egret.Ease.circIn)}},a}(egret.Sprite);__reflect(GameOverPanel.prototype,"GameOverPanel");var LevelElementView=function(e){function a(){var a=e.call(this)||this;return a.eltype="",a.init(),a}return __extends(a,e),Object.defineProperty(a.prototype,"num",{get:function(){return Number(this.bittext.text)},set:function(e){0>=e?this.checkmarkbit||(this.checkmarkbit=new egret.Bitmap,this.checkmarkbit.texture=RES.getRes("checkmark_png"),this.checkmarkbit.x=(this.bitmap.width-this.checkmarkbit.width)/2,this.checkmarkbit.y=this.bitmap.height+this.bitmap.y-this.checkmarkbit.height/2,this.addChild(this.checkmarkbit),this.removeChild(this.bittext)):this.bittext.text=e.toString()},enumerable:!0,configurable:!0}),a.prototype.init=function(){this.touchChildren=!1,this.bitmap||(this.bitmap=new egret.Bitmap);
var e=(GameData.stageW-40)/GameData.MaxColumn;this.bitmap.width=e,this.bitmap.height=e,this.addChild(this.bitmap),this.bittext=new egret.BitmapText,this.bittext.font=RES.getRes("number_fnt"),this.bittext.text="0",this.bittext.x=(e-this.bittext.width)/2,this.bittext.y=this.bitmap.height+this.bitmap.y-this.bittext.height/2,this.addChild(this.bittext)},a.prototype.setTexture=function(e){this.bitmap.texture=RES.getRes(e)},a}(egret.Sprite);__reflect(LevelElementView.prototype,"LevelElementView");var LevelReqViewManage=function(){function e(e){this._layer=e,this.init()}return e.prototype.init=function(){this.elements=new Array},e.prototype.createCurrentLevelReq=function(){for(var e,a=GameData.levelReq.getLevelReqNum(),t=0;a>t;t++)this.elements.length<=t?(e=new LevelElementView,this.elements.push(e)):e=this.elements[t],e.eltype=GameData.levelReq.reqElements[t].type,e.setTexture("e"+e.eltype+"_png"),e.x=43+(5+e.width)*t,e.y=95,e.num=GameData.levelReq.reqElements[t].num,this._layer.addChild(e);this.stepNumText||(this.stepNumText=new egret.BitmapText,this.stepNumText.font=RES.getRes("number_fnt"),this.stepNumText.x=GameData.stageW-95,this.stepNumText.y=90,this.stepNumText.scaleX=1.5,this.stepNumText.scaleY=1.5,this._layer.addChild(this.stepNumText),this.stepNumText.text=GameData.stepNum.toString())},e.prototype.haveReqType=function(e){for(var a=this.elements.length,t=0;a>t;t++)if(this.elements[t].eltype==e)return!0;return!1},e.prototype.updateStep=function(){this.stepNumText.text=GameData.stepNum.toString()},e.prototype.getPointByType=function(e){for(var a=new egret.Point,t=this.elements.length,n=0;t>n;n++)this.elements[n].eltype==e&&(a.x=this.elements[n].x+this.elements[n].width/2,a.y=this.elements[n].y+this.elements[n].height/2);return a},e.prototype.update=function(){console.log("更新关卡数量数据");for(var e=GameData.levelReq.getLevelReqNum(),a=0;e>a;a++)this.elements[a].num=GameData.levelReq.reqElements[a].num},e}();__reflect(LevelReqViewManage.prototype,"LevelReqViewManage");var PropView=function(e){function a(a){var t=e.call(this)||this;return t._type=-1,t.id=-1,t._num=0,t._type=a,t.init(),t}return __extends(a,e),Object.defineProperty(a.prototype,"proptype",{get:function(){return this._type},enumerable:!0,configurable:!0}),a.prototype.init=function(){this.createView(),this.createNumText(),this.addChild(this._view_active),this.addChild(this._view_box),this.addChild(this._numText),this.setActivateState(!0)},a.prototype.createNumText=function(){this._numText=new egret.BitmapText,this._numText.font=RES.getRes("number_fnt"),this._numText.x=this._view_active.width-31},a.prototype.createView=function(){var e=15,a=(GameData.stageW-6*e)/5;this._view_active||(this._view_active=new egret.Bitmap,this._view_active.texture=RES.getRes(this.getActivateTexture(this._type)),this._view_active.width=this._view_active.height=a),this._view_box||(this._view_box=new egret.Bitmap,this._view_box.texture=RES.getRes("propbox_png"),this._view_box.width=this._view_box.height=this._view_active.width+10,this._view_box.x=-5,this._view_box.y=-5)},Object.defineProperty(a.prototype,"num",{get:function(){return this._num},set:function(e){this._num=e,this._numText.text=e.toString(),0>=e?this.setActivateState(!1):this.setActivateState(!0)},enumerable:!0,configurable:!0}),a.prototype.getFocusTexture=function(e){var a="";switch(e){case 0:a="tongseactive_png";break;case 1:a="zhadanactive_png";break;case 2:a="zhenghangactive_png";break;case 3:a="zhenglieactive_png";break;case 4:a="chanziactive_png"}return a},a.prototype.getActivateTexture=function(e){var a="";switch(e){case 0:a="tongse_png";break;case 1:a="zhadan_png";break;case 2:a="zhenghang_png";break;case 3:a="zhenglie_png";break;case 4:a="chanzi_png"}return a},a.prototype.getDisableTexture=function(e){var a="";switch(e){case 0:a="tongsedisable_png";break;case 1:a="zhadandisable_png";break;case 2:a="zhenghangdisable_png";break;case 3:a="zhengliedisable_png";break;case 4:a="chanzidisable_png"}return a},a.prototype.setActivateState=function(e){this.touchEnabled=e,e?(this._view_active.texture=RES.getRes(this.getActivateTexture(this._type)),this._numText.font=RES.getRes("number_fnt")):(this._view_active.texture=RES.getRes(this.getDisableTexture(this._type)),this._numText.font=RES.getRes("numberdisable_fnt"))},a.prototype.setFocus=function(e){e?this._view_active.texture=RES.getRes(this.getFocusTexture(this._type)):this._num>0?this._view_active.texture=RES.getRes(this.getActivateTexture(this._type)):this._view_active.texture=RES.getRes(this.getDisableTexture(this._type))},a}(egret.Sprite);__reflect(PropView.prototype,"PropView");var PropLogic=function(){function e(){}return e.useProp=function(a,t){switch(a){case 0:e.tongse(t);break;case 1:e.zhadan(t);break;case 2:e.zhenghang(t);break;case 3:e.zhenglie(t);break;case 4:e.chanzi(t)}},e.chanzi=function(e){LinkLogic.lines=new Array,LinkLogic.lines.push([GameData.elements[GameData.mapData[Math.floor(e/GameData.MaxColumn)][e%GameData.MaxRow]].id])},e.zhadan=function(e){LinkLogic.lines=new Array;var a=Math.floor(e/GameData.MaxColumn),t=e%GameData.MaxRow,n=new Array;n.push(GameData.elements[GameData.mapData[a][t]].id),a>0&&-1!=GameData.mapData[a-1][t]&&n.push(GameData.elements[GameData.mapData[a-1][t]].id),a<GameData.MaxRow-1&&-1!=GameData.mapData[a+1][t]&&n.push(GameData.elements[GameData.mapData[a+1][t]].id),t>0&&-1!=GameData.mapData[a][t-1]&&n.push(GameData.elements[GameData.mapData[a][t-1]].id),t<GameData.MaxColumn-1&&-1!=GameData.mapData[a][t+1]&&n.push(GameData.elements[GameData.mapData[a][t+1]].id),LinkLogic.lines.push(n)},e.zhenghang=function(e){LinkLogic.lines=new Array;for(var a=new Array,t=Math.floor(e/GameData.MaxColumn),n=0;n<GameData.MaxColumn;n++)-1!=GameData.mapData[t][n]&&a.push(GameData.mapData[t][n]);LinkLogic.lines.push(a)},e.zhenglie=function(e){LinkLogic.lines=new Array;for(var a=new Array,t=e%GameData.MaxRow,n=0;n<GameData.MaxRow;n++)-1!=GameData.mapData[n][t]&&a.push(GameData.mapData[n][t]);LinkLogic.lines.push(a)},e.tongse=function(e){LinkLogic.lines=new Array;for(var a=new Array,t=GameData.elements[GameData.mapData[Math.floor(e/GameData.MaxColumn)][e%GameData.MaxRow]].type,n=0;n<GameData.MaxRow;n++)for(var i=0;i<GameData.MaxColumn;i++)-1!=GameData.mapData[n][i]&&GameData.elements[GameData.mapData[n][i]].type==t&&a.push(GameData.elements[GameData.mapData[n][i]].id);LinkLogic.lines.push(a)},e}();__reflect(PropLogic.prototype,"PropLogic");